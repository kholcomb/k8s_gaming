# SOLUTION: The Perfect Storm - FIXED!
# All World 5 concepts applied correctly

apiVersion: v1
kind: Namespace
metadata:
  name: k8squest
  labels:
    pod-security.kubernetes.io/enforce: restricted

---
# âœ… 1. ResourceQuota - Reasonable limits
apiVersion: v1
kind: ResourceQuota
metadata:
  name: chaos-quota
  namespace: k8squest
spec:
  hard:
    requests.cpu: "2"  # âœ… Increased
    requests.memory: "2Gi"
    pods: "10"

---
# âœ… 2. RBAC - ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-sa
  namespace: k8squest

---
# âœ… 3. RBAC - Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: app-role
  namespace: k8squest
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]

---
# âœ… 4. RBAC - RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: app-binding
  namespace: k8squest
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: app-role
subjects:
- kind: ServiceAccount
  name: app-sa

---
# âœ… 5. NetworkPolicy - Allow necessary traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-app
  namespace: k8squest
spec:
  podSelector:
    matchLabels:
      app: chaos
  policyTypes: [Ingress, Egress]
  ingress:
  - from:
    - podSelector: {}
  egress:
  - to:
    - podSelector: {}
  - to:  # DNS
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - port: 53
      protocol: UDP

---
# âœ… 6. PriorityClass
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: production-priority
value: 1000
globalDefault: false
description: "Production workloads"

---
# âœ… 7. Deployment - ALL FIXES APPLIED!
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chaos-app
  namespace: k8squest
spec:
  replicas: 2  # âœ… Reduced to fit quota
  selector:
    matchLabels:
      app: chaos
  template:
    metadata:
      labels:
        app: chaos
    spec:
      serviceAccountName: app-sa
      priorityClassName: production-priority  # âœ… Priority
      tolerations:  # âœ… Tolerate taints
      - key: "dedicated"
        operator: "Exists"
        effect: "NoSchedule"
      affinity:  # âœ… Node affinity (if needed)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: kubernetes.io/hostname
                operator: Exists
      securityContext:  # âœ… Pod-level security
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: app
        image: nginx:latest
        command: ['sh', '-c', 'echo "ðŸŽ‰ ALL SYSTEMS OPERATIONAL! The storm has passed!"; sleep 3600']
        resources:
          requests:
            cpu: "200m"  # âœ… Fits quota
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        securityContext:  # âœ… Container security
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop: [ALL]
          readOnlyRootFilesystem: false

---
# âœ… 8. PodDisruptionBudget - Realistic
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: chaos-pdb
  namespace: k8squest
spec:
  minAvailable: 1  # âœ… Realistic for 2 replicas
  selector:
    matchLabels:
      app: chaos

# ðŸŽ‰ ALL FIXED!
# âœ… RBAC: ServiceAccount + Role + RoleBinding
# âœ… SecurityContext: Non-root, no escalation, capabilities dropped
# âœ… ResourceQuota: Reduced requests to fit quota
# âœ… NetworkPolicy: Allow necessary ingress/egress + DNS
# âœ… Node Affinity: Configured (preferred)
# âœ… Tolerations: Can schedule on tainted nodes
# âœ… PDB: Realistic minAvailable
# âœ… Pod Security: Meets restricted standard
# âœ… PriorityClass: Production priority assigned
#
# THE STORM HAS PASSED! ðŸŒˆ

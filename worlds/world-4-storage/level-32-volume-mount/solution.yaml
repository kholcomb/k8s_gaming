---
apiVersion: v1
kind: Namespace
metadata:
  name: k8squest
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: config-storage
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: standard
  hostPath:
    path: /tmp/k8squest-config
    type: DirectoryOrCreate
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: config-pvc
  namespace: k8squest
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard
  resources:
    requests:
      storage: 1Gi
---
# ✅ FIXED: Volume now mounted at correct path /app/config
apiVersion: v1
kind: Pod
metadata:
  name: web-app
  namespace: k8squest
spec:
  containers:
  - name: app
    image: busybox:1.28
    command: 
    - sh
    - -c
    - |
      echo "Starting application..."
      if [ ! -f /app/config/app.conf ]; then
        echo "ERROR: Config file not found at /app/config/app.conf"
        exit 1
      fi
      echo "Config loaded successfully from /app/config/app.conf"
      cat /app/config/app.conf
      sleep 3600
    volumeMounts:
    - name: config-volume
      mountPath: /app/config  # ✅ FIXED! Matches app's expected path
  volumes:
  - name: config-volume
    persistentVolumeClaim:
      claimName: config-pvc
  initContainers:
  - name: setup-config
    image: busybox:1.28
    command:
    - sh
    - -c
    - |
      echo "app_name=MyApp" > /app/config/app.conf
      echo "version=1.0" >> /app/config/app.conf
      echo "Config file created at /app/config/app.conf"
    volumeMounts:
    - name: config-volume
      mountPath: /app/config  # ✅ Same mount path for consistency
